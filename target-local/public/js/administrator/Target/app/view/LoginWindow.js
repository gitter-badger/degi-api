/*
 * File: app/view/LoginWindow.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Target.view.LoginWindow', {
    extend: 'Ext.window.Window',
    alias: 'widget.loginwindow',

    requires: [
        'Target.view.LoginWindowViewModel',
        'Ext.form.Panel',
        'Ext.form.field.Text',
        'Ext.toolbar.Toolbar',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'loginwindow'
    },
    height: 203,
    id: 'loginWindow',
    width: 310,
    closable: false,
    title: '管理者登入',
    modal: true,
    defaultListenerScope: true,

    items: [
        {
            xtype: 'form',
            id: 'loginForm',
            bodyPadding: 10,
            title: '',
            items: [
                {
                    xtype: 'textfield',
                    anchor: '100%',
                    margin: '20 0 25 0 ',
                    fieldLabel: '帳號',
                    labelWidth: 35,
                    name: 'a_account'
                },
                {
                    xtype: 'textfield',
                    anchor: '100%',
                    fieldLabel: '密碼',
                    labelWidth: 35,
                    name: 'a_password',
                    inputType: 'password',
                    listeners: {
                        specialkey: 'onTextfieldSpecialkey'
                    }
                }
            ]
        }
    ],
    dockedItems: [
        {
            xtype: 'toolbar',
            dock: 'bottom',
            height: 47,
            layout: {
                type: 'hbox',
                pack: 'end'
            },
            items: [
                {
                    xtype: 'button',
                    width: 291,
                    text: '登入',
                    listeners: {
                        click: 'onButtonClick'
                    }
                }
            ]
        }
    ],

    onTextfieldSpecialkey: function(field, e, eOpts) {
        var form = Ext.getCmp('loginForm').getForm();

        if(form.isValid()){
            var a_account = form.findField('a_account').getValue();
            var a_password = form.findField('a_password').getValue();

            Ext.Ajax.request({
                method: 'POST',
                url: 'http://dev.finpo.com.tw/degi-api/target-local/public/b/auth',
                params: {
                    a_account: a_account,
                    a_password: a_password
                },
                success: function(response, opts){
                    var obj = Ext.decode(response.responseText);

                    if(obj.success === true && obj.data.a_status == 1){

                        Ext.Ajax.request({
                            method: 'GET',
                            url: 'http://dev.finpo.com.tw/degi-api/target-local/public/b/auth',
                            success: function(response, opts){
                                var obj = Ext.decode(response.responseText);
                                //console.log(obj);
                            }
                        });

                        var window = Ext.getCmp('loginWindow');
                        window.close();
                    }else if(obj.success === true && obj.data.a_status == 2){
                        Ext.Msg.alert('提示', '帳號已停用');
                    }else{
                        Ext.Msg.alert('提示', '登入失敗，請檢查您的帳號或密碼');
                    }
                },
                failure: function(response, opts){
                    console.log('server-side failure with status code ' + response.status);
                }
            });
        }
    },

    onButtonClick: function(button, e, eOpts) {

        var form = Ext.getCmp('loginForm').getForm();

        if(form.isValid()){
            var a_account = form.findField('a_account').getValue();
            var a_password = form.findField('a_password').getValue();

            Ext.Ajax.request({
                method: 'POST',
                url: 'http://dev.finpo.com.tw/degi-api/target-local/public/b/auth',
                params: {
                    a_account: a_account,
                    a_password: a_password
                },
                success: function(response, opts){
                    var obj = Ext.decode(response.responseText);

                    if(obj.success === true && obj.data.a_status == 1){

                        Ext.Ajax.request({
                            method: 'GET',
                            url: 'http://dev.finpo.com.tw/degi-api/target-local/public/b/auth',
                            success: function(response, opts){
                                var obj = Ext.decode(response.responseText);
                                //console.log(obj);
                            }
                        });

                        var window = Ext.getCmp('loginWindow');

                        window.close();

                    }else if(obj.success === true && obj.data.a_status == 2){
                        Ext.Msg.alert('提示', '帳號已停用');
                    }else{
                        Ext.Msg.alert('提示', '登入失敗，請檢查您的帳號或密碼');
                    }
                },
                failure: function(response, opts){
                    console.log('server-side failure with status code ' + response.status);
                }
            });
        }
    }

});